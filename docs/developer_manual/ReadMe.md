# Руководство начинающего разработчика для EasyEPlanner #

Данное руководство служит новичкам для ознакомления с решением и углубления знаний в проекте без непосредственного исследования кода. Помимо этого руководства, желательно ещё изучить руководство пользователя т.к позволяет изучить варианты использования системы пользователями, а также пользовательский функционал.

**Примечание**: надстройка работает только с одним открытым проектом в EPLAN.

Дополнение подключается к версии **EPLAN 2.8** (*сейчас 2.9*) и новее. Пользовательская документация - [тык](https://github.com/savushkin-r-d/EasyEPLANner/tree/master/docs/user_manual). Документация по API - [тык](https://www.eplan.help/en-US/infoportal/content/api/2.9/index.html).
## Содержание ##
1-Технологический-стек-и-проекты

## 1. Технологический стек и проекты ##

Решение **EasyEPlanner.sln** для Visual Studio  содержит в себе **5** проектов:
1. **Aga.Controls** - проект UI элемента управления.
2. **EasyEPlanner** - основной проект дополнения для Eplan.
3. **EasyEplanner.Tests** - проект с юнит-тестами для дополнения. Используется NUnit, как фреймворк и Mock библиотека, как создатель Mock и Stub объектов. Stub - содержат только состояние, а Mock - поведение. Fake объект - содержит в себе и поведение, и состояние (*почитайте теорию*).
4. **EplanIdleTimeModule** - модуль простоя Eplan. Используется как отдельно, так и как часть EasyEPlanner.
5. **ObjectListView2012** - проект UI элемента управления для редактора технологических объектов.

Все проекты написаны на языке **C#** с применением технологии **.Net Framework** версии **4.5** (*Aga.Controls, ObjectListView2012*), версии **4.7.2** (*EasyEPlanner*) и версии **.Net Core 3.1** (*EasyEplanner.Tests*). Дополнительно в проекте **EasyEPlanner** используется скриптовый язык **Lua**.

Проекты **1**, **4** и **5** используется в **EasyEPlanner** как подмодули (*submodules*).

### 1.1 Aga.Controls ###

Проект содержит в себе UI-компонент, который используется в EasyEPlanner в окнах, открывающихся через пункты меню: "**Устройства, параметры объектов**" и "**Операции, ограничения и привязка объектов**".

Сам проект не нужно постоянно собирать и подписывать строгим именем т.к. он уже был собран и используется в EasyEPlanner через ссылку на dll-библиотеку(_папка libs_). При Debug или Release сборке решения он будет собираться по необходимости, но копироваться будет версия из папки libs, которая уже подписана и используется и при её замене никаких сайд эффектов быть не должно.

### 1.2 EasyEPlanner ###

Основной проект решения Visual Studio. Более подробное описание функционала можно найти в пользовательской документации. Используется в основном для описания управляющей программы для ПЛК. Описание загружается и сохраняется из **Lua** кода. Для взаимодействия с **EPLAN** используется **EPLAN API**. Надстройка может выгружать Excel отчеты, генерировать XML описание базы каналов для SCADA, считывать информацию с схем автоматизации (устройства, плк), а также поддерживает привязку каналов устройств к клеммам модулей-ввода вывода и др. Более подробно в пользовательской документации.

### 1.3 EasyEplanner.Tests ###

Проект с unit-tests, использует **EasyEPlanner** как ссылку, для тестирования. Написаны на .Net Core 3.1, но **ВНИМАНИЕ**, тесты не полностью покрывают тестами надстройку. Нужно каждый раз запускать тесты, после внесения изменений, а после, для нового функционала - писать новые, которые покрывают сценарии использования функционала. Юнит-тесты именуются по конвенции, из названий методов можно примерно понять, что они тестируют, и какой результат будет на выходе.

Конвенция нейминга - *UnitOfWork_StateUnderTest_ExpectedBehavior*. Но можно использовать современное и миксовать (*что, вроде как, встречается в коде*).

### 1.4 EplanIdleTimeModule ####

Проект модуля простоя **EPLAN**. Суть: по достижении определенного времени (*настраивается в конфигурации*), если пользователь не пользовался системой (*заблокировал компьютер через Win + L или что-то ещё*), то **EPLAN** будет выключен т.к лицензий конечное количество, а пользователей гораздо больше, чем лицензий (*иногда свободны все лицензии, а иногда нужно ждать, когда освободится*).

Надстройка может подключаться отдельно от **EasyEplanner**, так и использоваться в **EasyEplanner** (_используешь её как ссылку и получаешь доступ к классам, возможность запускать модуль и подписаться на события_). Не рекомендуется использовать одновременно в описанных случаях т.к неизвестны последствия.

### 1.5 ObjectListView2012 ###

Проект UI-компонента, использующегося в EasyEPlanner для окна "**Редактировать технологические объекты**". Сборка и использование - аналогично пункту [1.1 Aga.Controls](#1.1-Aga.Controls).

## 2. Файловая структура ##

В большинстве случаев, файлы исходного кода прокомментированы через _summary_ нотацию, что облегчает изучение кода, но иногда комментарий может быть обманчив (_легаси_). **Lua** скрипты в своем большинстве тоже прокомментированы.

### 2.1 Файловая структура готовой для использования надстройки ###

Не все файлы создаются сразу приложением, некоторые копируются из других проектов. К примеру - описание технологических объектов, но об этом ниже.

#### 2.1.1 Корневой каталог ####

<p style="text-align:center"><img src="images/eplanner-folder.png" /></p>
<p style="text-align:center">Рисунок - Общий вид каталога надстройки</p>

Описание:
1. CMD - скрипты в **.txt** формате, которые используются для проверки наличия установленного **Lua**, а также для запуска автоматического тестирования проектов.
2. Documentation - документ для настройки **Lua** в системе, чтобы работало тестирование проекта **EPLAN**.
3. Lua - вспомогательные скрипты (*описано ниже*), а также описание базовых объектов из репозитория **ptusa-lua-diary-sys**.
4. LuaInterface - подписанные библиотеки для работы с **Lua** через **C#** код и наоборот. Дублируются библиотеки *LuaInterface* и *KopiLua* из корня каталога (*легаси код, не переделывал*).
5. Aga.Controls.dll - подписанная библиотека с UI-элементом [1.1 Aga.Controls](#1.1-Aga.Controls).
6. configuration.ini - файл конфигурации для **EasyEPlanner**. Генерируется автоматически, если отсутствует, а потом в него уже записываются настройки. Описан в следующем разделе.
7. EPLAN.EplAddin.EasyEPlanner.dll - основная подписанная библиотека надстройки. Именно этот файл всегда подключается к **EPLAN**. В основном, когда вносятся изменения в проект, то чаще всего, этот файл меняется, а другие файлы остаются неизменными.
8. EPLAN.EplAddin.IdleTimeModule.dll - подписанная библиотека модуля простоя.
9. EPLAN.EplAddin.IdleTimeModule.dll.config - файл конфигурации модуля простоя. Описан в следующем разделе.
10. KopiLua и LuaInterface - смотри пункт 4.
11. ObjectListView - аналогично с пунктом 5, только для [1.5 ObjectListView2012](#1.5-ObjectListView2012).
12. Spire.License, Spire.Pdf, Spire.XLS - библиотеки, использующиеся для генерации **Excel** отчетов.

#### 2.1.2 Каталог CMD ####

<p style="text-align:center"><img src="images/cmd-folder.png" /></p>
<p style="text-align:center">Рисунок - Каталог CMD</p>

Описание:
1. TestLuaAvailability.txt - скрипт для проверки наличия **Lua** в системе. Запускается процессом из EasyEPlanner.
2. TestProjectScript.txt - скрипт, запускающий тестирование после проверки наличия **Lua** в системе.

#### 2.1.3 Каталог Lua ####

<p style="text-align:center"><img src="images/lua-folder.png" /></p>
<p style="text-align:center">Рисунок - Каталог Lua</p>

Описание:
1. BaseObjectsDescriptionFiles - каталог с описанием базовых объектов. Берется из репозитория **ptusa-lua-diary-system**. Если файлов нет - будет автоматически создан вместе с начальным пустым описанием.
2. mainPattern.plua - шаблон файла **main.plua**, можно менять в реалтайме. Генерируется **1** раз, при создании проекта (_часто пользователи копируют файлы проекта и сам проект, а потом просто переделывают, поэтому генерируется редко, но иногда нужно, чтобы шаблон менялся_).
3. sys.lua - файл с **Lua** скриптами, которые загружают описание из **Lua** файлов, в частности, технологических объектов проекта в надстройку. Меняется довольно часто, когда меняется структура **Lua** файлов.
4. sys_base_objects_initializer.lua - скрипт, которые инициализирует базовые объекты, считываемые из папки (_см. пункт 1_). Меняется в зависимости от изменений базовых объектов.
5. sys_device_mock_generator.lua - скрипт делающий затычки для устройств, когда настраивается межпроектный обмен сигналами (_см. пользовательскую документацию_). При добавлении в EasyEPlanner нового устройства (_но не подтипа уже существующего устройства_), нужно обязательно добавить генерирование заглушки для него, иначе будет ошибка при загрузке межпроектного обмена.
6. sys_interproject_io.lua - скрипт чтения описания **Lua** с файла *main.io.lua* для загрузки межпроектного обмена сигналами.
7. sys_io.lua - скрипт с описанием модулей-ввода вывода, которые поддерживаются надстройкой. ПЛК зашиты в исходном коде (_легаси_).
8. sys_iolink_devices.lua - скрипт с описанием поддерживаемых IO-Link устройств.
9. sys_restriction.lua - скрипт читающий описание ограничений для технологических объектов (*всегда запускается после sys.lua*).
10. sys_shared_initializer.lua - скрипт читающий межпроектный обмен из файла *main.shared.lua* проекта.

#### 2.1.4 Каталог BaseObjectsDescriptionFiles ####

Нужно немного рассказать о том, как это работает. Базовые объекты могут быть любые, и их может быть любое количество. Главное, чтобы в файлах они не пересекались. Надстройка загружает из каждого файла базовые объекты, поэтому можно разделить их по разным критериям и использовать так, как надо пользователю. В этой папке всегда должен быть файл с описанием, иначе могут слететь в проектах базовые объекты со всеми настройками. В SVN репозитории файл зафиксирован (*sys_base_objects_description.lua*), который используется АСУТП. Если файла нет, то он будет создан автоматически, а внутри его будет базовое описание и комментарии о том, как заполнять этот файл. Дополнительно можно в папке Lua посмотреть файл **sys_base_object_initializer.lua**, которые показывает, что читается, и куда отправляется.

<p style="text-align:center"><img src="images/base-objects-folder.png" /></p>
<p style="text-align:center">Рисунок - Каталог BaseObjectsDescriptionFiles в каталоге Lua</p>



### 2.2 Описание файла configuration.ini и EPLAN.EplAddin.IdleTimeModule.dll.config ###

## 3. Сборка проекта и подписывание библиотек ключом EPLAN ##

### 3.1 Сборка через терминал ###

### 3.2 Сборка через Visual Studio ###

## Часто задаваемые вопросы ##